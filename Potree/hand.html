<html>
<head>

<link rel="stylesheet" type="text/css" href="resources/style/potree.css" />
<script type="text/javascript" src="config.js"></script>

<script type="text/javascript" src="src/Potree.js"></script>
<script type="text/javascript" >Potree.importScripts("./");</script>
<script src="pointclouds.js"></script>

<script type="text/javascript">
function requestFullscreen(target){
	if (target.requestFullScreen) {  
		if(document.fullscreen){
			document.exitFullscreen();
		}else{
			target.requestFullScreen();  
		}
	} else if (target.mozRequestFullScreen) {
		if(document.mozFullScreen){
			document.mozCancelFullScreen();
		}else{
			target.mozRequestFullScreen();  
		}
	} else if (target.webkitRequestFullScreen) {  
		if(document.webkitIsFullScreen){
			document.webkitCancelFullScreen();
		}else{
			target.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);  
		}
	}
}

var mnoNodes = new Object();
var activeMnoNode;

function init() {
	//Logger.setWindowState(LoggerWindowState.MINIMIZED);
	
	// initialization
	var success = Potree.init($('canvas'));
	if(!success){
		return;
	}
	
	// shaders
	var drawTextureShader = new DrawTextureShader("drawTexture");
	var defaultShader = new PhongShader("default");
	var defaultFlat = new FlatShader("defaultFlat");
	var aabbShader = new FlatShader("AABB");
	
	// materials
	var aabbMaterial = new FlatMaterial("aabb");
	var defaultMaterial = new PhongMaterial("default");
	var pointCloudMaterial = new PointCloudMaterial("pointCloud");

	TextureManager.loadTexture("resources/textures/texture.jpg", "texture");

	// scenegraph
	var scene = Potree.currentScene;
	var cam = scene.activeCamera;
	
	// lights
	var light = new Light("light", scene.rootNode);
	light.translate(100,100,100);

	// camera
	cam.translate(0,1.0,0);
	Potree.draw();
	
	$('canvas').focus();

	mainLoop();
	
	loadCloud("Hand");
}

var fpsHistory = new Array();
function update(time){
	
	
	var fps = 1 / time;

	fpsHistory.push(fps);
	if(fpsHistory.length > 10){
		fpsHistory.splice(0, 1);
	}
	var mean = 0;
	for(var i = 0; i < fpsHistory.length; i++){
		mean += fpsHistory[i];
	}
	mean = mean / fpsHistory.length;
	
	Potree.update(time);
	Potree.camHandler.update(time);
//	debugView.set("FPS:", mean.toFixed(2));
}

var lastLoopTime = null;
var timeSinceLastFrame = null;
function calculateTimeSinceLastFrame(){
	var newDrawTime = new Date().getTime();
	var fps = null;
	if (lastLoopTime != null) {
		timeSinceLastFrame = (newDrawTime - lastLoopTime) / 1000.0;
	}else{
		timeSinceLastFrame = 0;
	}
	lastLoopTime = new Date().getTime();

}

function mainLoop(){
	calculateTimeSinceLastFrame();

	update(timeSinceLastFrame);
	Potree.draw();
	
	// with 0ms, interaction becomes a lot slower in firefox.
	setTimeout(mainLoop, 10);
// 	window.webkitRequestAnimationFrame (mainLoop);
}

function loadCloud(name){
	var cloud = pointclouds[name];
	if(cloud == null){
		return;
	}
	
	var scene = Potree.currentScene;
	var cam = scene.activeCamera;
	
	var pointCloudMaterial = MaterialManager.getMaterial("pointCloud");
	
	if(activeMnoNode != null){
		activeMnoNode.setVisible(false);
	}
	
	if(mnoNodes[cloud.name] == null){
		
		var loader = new POCLoader();
		var mno = loader.load(cloud.url);
		
		var mnoNode = new PointcloudOctreeSceneNode(cloud.name, mno, scene.rootNode);
		mnoNode.rotate(-Math.PI / 2.0, V3.$(1,0,0));
		if(cloud.scale != null){
			mnoNode.scale(cloud.scale[0], cloud.scale[1], cloud.scale[2]);
		}
		if(cloud.transform != null){
			mnoNode.transform = cloud.transform;
		}
		activeMnoNode = mnoNode;
		mnoNodes[cloud.name] = mnoNode;
		
		cam.setTransform(M4x4.I);
		cam.translate(cloud.camPosition[0], cloud.camPosition[1], cloud.camPosition[2]);
		
		setIlluminationMode(cloud.illumination);
		setPointSize(cloud.pointSize);

		if(activeMnoNode != null){
			activeMnoNode.setVisible(true);
		}
		
	}else{
		activeMnoNode = mnoNodes[cloud.name];
		
		cam.setTransform(M4x4.I);
		cam.translate(cloud.camPosition[0], cloud.camPosition[1], cloud.camPosition[2]);
		
		setIlluminationMode(cloud.illumination);
		setPointSize(cloud.pointSize);

		if(activeMnoNode != null){
			activeMnoNode.setVisible(true);
		}
	}
}


function setIlluminationMode(mode){
	var material = MaterialManager.getMaterial("pointCloud");
	if(mode == "flat"){
		material.setIlluminationMode(PointCloudIlluminationMode.FLAT);
	}else if(mode == "phong"){
		material.setIlluminationMode(PointCloudIlluminationMode.PHONG);
	}else if(mode == "normals"){
		material.setIlluminationMode(PointCloudIlluminationMode.NORMALS);
	}
	
}

function setRendermode(mode){
	var material = MaterialManager.getMaterial("pointCloud");
	if(mode == "fixedCircles"){
		material.setRenderMode(PointCloudRenderMode.FIXED_CIRCLE);
	}else if(mode == "weightedCircles"){
		material.setRenderMode(PointCloudRenderMode.WEIGHTED_CIRCLE);
	}else if(mode == "gaussianSplats"){
		material.setRenderMode(PointCloudRenderMode.GAUSSIAN_SPLAT);
	}
}

function setPointSize(size){
	var material = MaterialManager.getMaterial("pointCloud");
	material.setPointSize(size);
}

function setSigmaFactor(sigmaFactor){
	var material = MaterialManager.getMaterial("pointCloud");
	material.setSigmaFactor(sigmaFactor);
}

function setBlendDepth(blendDepth){
	var material = MaterialManager.getMaterial("pointCloud");
	material.setBlendDepth(blendDepth);
}

function setGlossiness(glossiness){
	var material = MaterialManager.getMaterial("pointCloud");
	material.setGlossiness(glossiness);
}


</script>
    
</head>
 <body onload="init()" class="claro">

		<div id="workarea" style="width: 100%; height: 100%">
			<canvas id="canvas" width="800" height="600" tabIndex="1"
				ondblclick="requestFullscreen(this)">
				Your Browser does not support WebGL. Try the newest version of Firefox or Google Chrome.
			</canvas>
		</div>
	
</body>
</html>